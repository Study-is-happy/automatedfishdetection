import numpy as np
import cv2
import matplotlib.pyplot as plt

import util

left_image = cv2.imread('/home/auv/venv3/port_2.png')
right_image = cv2.imread('/home/auv/venv3/stbd_2.png')

gray_left_image = cv2.cvtColor(left_image, cv2.COLOR_BGR2GRAY)
gray_right_image = cv2.cvtColor(right_image, cv2.COLOR_BGR2GRAY)

image_size = (gray_left_image.shape[1], gray_left_image.shape[0])

left_points = np.array([(566.7879979871714, 1857.2148341437176),
                        (556.48006230904, 1496.944044031442),
                        (738.8300545025766, 1642.69435749255),
                        (1047.592068889618, 1626.3166665560632),
                        (1222.9479895867125, 1578.1361809506063),
                        (1680.6996138633604, 1635.6179903761447),
                        (1928.3630891583662, 1619.4391819881819),
                        (2153.19046289, 1799.22759759),
                        (2052.400631951202, 1043.9631839632202),
                        (2144.9145865035543, 400.8238786276799),
                        (595.0741538266745, 310.27970491412947),
                        (1204.8252090268081, 1153.736207720668),
                        (551.7480905661412, 1749.898599589876),
                        (812.9876058355998, 1900.3319299020925),
                        (830.4152656594343, 1505.8143324396674),
                        (1022.2786491241119, 1428.4575762876564),
                        (1687.6568239633948, 1546.2965952985933),
                        (1940.0883314456835, 1544.1333911157365),
                        (2060.317069622082, 948.6542767522217),
                        (949.8234641054901, 590.8340263424695),
                        (825.4667728201604, 376.3891384382801)])

right_points = np.array([(393.3189882316195, 1819.190772258953),
                         (405.11309478958896, 1459.7732865064888),
                         (576.9450114197928, 1613.7775601948226),
                         (879.4286445506177, 1614.237570706243),
                         (1043.0298779808215, 1575.475757465095),
                         (1510.3025631751586, 1656.514881470824),
                         (1760.0722694393278, 1653.5264326539786),
                         (1978.76320646, 1846.2016206),
                         (1898.7511489366004, 1083.0441695717714),
                         (2011.2481658027355, 442.94624478329405),
                         (470.121237070738, 281.6413185257459),
                         (1047.0383117848035, 1149.8329132632855),
                         (397.0748987150673, 1710.136595038208),
                         (648.8261250778914, 1874.0444380546871),
                         (681.3665789568653, 1482.8567590210976),
                         (872.0229101192758, 1415.671459843137),
                         (1530.079415282968, 1566.7301312470304),
                         (1783.118519689035, 1577.544215793785),
                         (1923.1164483410987, 987.8108587774306),
                         (833.4923913074168, 578.2442223586635),
                         (717.8517039466391, 356.61949489867925)])

fundamental_mat, good_mask = cv2.findFundamentalMat(left_points, right_points, cv2.FM_8POINT)

_, left_homography_matrix, right_homography_matrix = cv2.stereoRectifyUncalibrated(left_points,
                                                                                   right_points,
                                                                                   fundamental_mat, image_size)

left_image = cv2.warpPerspective(left_image, np.array([[1., 0., 64.],
                                                       [0., 1., 0.],
                                                       [0., 0., 1.]]).dot(left_homography_matrix), image_size)
right_image = cv2.warpPerspective(right_image, right_homography_matrix, image_size)

cv2.imwrite('/home/auv/venv3/port_2_my_rect.png', left_image)
cv2.imwrite('/home/auv/venv3/stbd_2_my_rect.png', right_image)
plt.imshow(left_image)
plt.show()
plt.imshow(right_image)
plt.show()
